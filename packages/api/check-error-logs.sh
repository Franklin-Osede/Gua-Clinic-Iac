#!/bin/bash

# Script para revisar logs de errores del calendario
# Uso: ./check-error-logs.sh [doctorId] [fecha]

DOCTOR_ID=${1:-56}
FECHA=${2:-20251101}

echo "ğŸ” Revisando logs de errores para doctor-availability"
echo "=================================================="
echo "ğŸ“‹ ParÃ¡metros:"
echo "   Doctor ID: $DOCTOR_ID"
echo "   Fecha: $FECHA"
echo ""

# Verificar si estamos en AWS o local
if [ -f ".env.production" ] || [ -n "$AWS_REGION" ]; then
    echo "ğŸŒ Detectado: Entorno de producciÃ³n (AWS)"
    echo ""
    echo "ğŸ“ Para ver logs de CloudWatch, ejecuta:"
    echo "   ./view-cloudwatch-logs.sh"
    echo ""
    echo "ğŸ” Busca especÃ­ficamente estos mensajes en CloudWatch:"
    echo "   - 'âŒ Error en DoctorAvailabilityController.getDoctorAgenda'"
    echo "   - 'âŒ Error en peticiÃ³n a DriCloud GetAgendaDisponibilidad'"
    echo "   - 'âŒ getDoctorAgenda: doctorId invÃ¡lido'"
    echo "   - 'Request blocked by rate limiting'"
    echo "   - 'Circuit breaker'"
    echo ""
else
    echo "ğŸ’» Detectado: Entorno local"
    echo ""
    echo "ğŸ“‹ Si el backend estÃ¡ corriendo localmente:"
    echo "   1. Ve a la terminal donde estÃ¡ corriendo 'npm run start:dev'"
    echo "   2. Busca estos mensajes:"
    echo ""
    echo "   ğŸ” Busca especÃ­ficamente:"
    echo "   - 'ğŸ¯ DoctorAvailabilityController.getDoctorAgenda called'"
    echo "   - 'ğŸ” DoctorAvailabilityService.getDoctorAgenda called'"
    echo "   - 'ğŸ“… Requesting agenda for doctor $DOCTOR_ID'"
    echo "   - 'âŒ Error en DoctorAvailabilityController'"
    echo "   - 'âŒ Error en peticiÃ³n a DriCloud'"
    echo "   - 'Request blocked by rate limiting'"
    echo ""
    echo "   ğŸ’¡ Si no ves logs, verifica que el backend estÃ© corriendo:"
    echo "      cd packages/api && npm run start:dev"
    echo ""
fi

echo ""
echo "ğŸ“Š InformaciÃ³n que necesito para diagnosticar:"
echo "=============================================="
echo ""
echo "1. âœ… Â¿QuÃ© mensajes de error aparecen?"
echo "   (Copia y pega los mensajes que empiezan con âŒ)"
echo ""
echo "2. âœ… Â¿Aparece algÃºn mensaje sobre 'rate limiting'?"
echo ""
echo "3. âœ… Â¿Aparece algÃºn mensaje sobre 'token' o 'autenticaciÃ³n'?"
echo ""
echo "4. âœ… Â¿Aparece algÃºn mensaje sobre 'Circuit breaker'?"
echo ""
echo "5. âœ… Â¿QuÃ© dice el 'Error stack'? (si aparece)"
echo ""
echo "6. âœ… Â¿CuÃ¡l es el cÃ³digo de estado HTTP exacto?"
echo "   (500, 502, 503, timeout, etc.)"
echo ""
echo "7. âœ… Â¿QuÃ© respuesta viene de DriCloud?"
echo "   (Si hay logs de 'GetAgendaDisponibilidad response')"
echo ""
echo ""
echo "ğŸ§ª Para probar manualmente el endpoint:"
echo "======================================"
echo ""
echo "curl -X GET \\"
echo "  'http://localhost:3000/doctor-availability/$DOCTOR_ID/$FECHA?dates_to_fetch=31' \\"
echo "  -H 'accept: application/json'"
echo ""
echo "O si estÃ¡s usando la API Gateway de producciÃ³n:"
echo ""
echo "curl -X GET \\"
echo "  'https://ybymfv93yg.execute-api.eu-north-1.amazonaws.com/prod/doctor-availability/$DOCTOR_ID/$FECHA?dates_to_fetch=31' \\"
echo "  -H 'accept: application/json'"
echo ""

